<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap-theme.min.css" type="text/css">
  <link rel="stylesheet" href="code_style.css" type="text/css">
  <meta charset="utf-8">
  <title>Ketrew 0.0.1-prealpha</title>
</head>
  <body><div class="container">
<h1 id="KetrewKeepTrackofExperimentalWorkflows">Ketrew: Keep Track of Experimental Workflows</h1>
<p>This is <strong>Work in Progress</strong>, not ready for use.</p>
<p>This documentation is available at <a href='http://seb.mondet.org/ketrew/'>http://seb.mondet.org/ketrew/</a>.</p>
<h2 id="BuildInstall">Build &amp; Install</h2>
<h3 id="Dependencies">Dependencies</h3>
<p>Ketrew depends on</p>
<ul>
 <li><code>nonstd</code>: nano-library providing a portable extract of <code>Core_kernel</code></li>
 <li><code>pvem</code>: error monad</li>
 <li><code>docout</code>: logging with <code>smart-print</code></li>
 <li><code>sosa</code>:  String module/functor</li>
 <li><code>pvem_lwt_unix</code>: <code>Lwt_unix</code> wrapped in a <code>Pvem.t</code> (error monad) with more
precise error types.</li>
 <li><code>uri</code>:
parse <a href='http://www.ietf.org/rfc/rfc3986.txt'>RFC-3986</a>-compliant URIs
(<code>uri</code> itself depends on <code>camlp4</code>).</li>
 <li><code>cmdliner</code>: command line parsing</li>
 <li><code>yojson</code>: JSON parsing/printing</li>
 <li><code>atdgen/atd</code>: definition of serialization formats (used with <code>Yojson</code>).</li>
 <li><code>toml</code>: config-file parsing</li>
</ul>

<p>and uses the <code>ocp-build</code> build system.</p>
<p>The <code>please.sh</code> script can call <code>opam</code> itself:</p>
<pre><code>./please.sh get-dependencies</code></pre>
<h3 id="Build">Build</h3>
<p>Then you may setup and build everything:</p>
<pre><code>./please.sh build</code></pre>
<p>(for incremental compilation while developping please use: <code>ocp-build &lt;target&gt;</code>
directly)</p>
<p>You should not install <code>ketrew</code> yet, but you can always call at your own risk:</p>
<pre><code>ocp-build install</code></pre>
<h3 id="BuildTheDocumentation">Build The Documentation</h3>
<p>The documentation depends on <a href='https://github.com/ocaml/omd'>omd</a>,
<a href='http://zoggy.github.io/higlo/'>higlo</a>,
and Graphviz&#39;s <code>dot</code>:</p>
<pre><code>please.sh doc</code></pre>
<p>and check-out <code>_doc/index.html</code>.</p>
<h2 id="Usage">Usage</h2>
<p>A workflow script is an OCaml file (script, compiled, or even inside the
toplevel).</p>
<p>The minimal file running Ketrew would be:</p>
<pre class='ocaml'><code class='ocaml'><span class="kw">let</span><span class="text"> `</span><span class="kw2">Never_returns</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">db_file</span><span class="text"> = </span><span class="string">&quot;/path/to/ketrew_database&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = </span><span class="kw2">Ketrew_state</span><span class="text">.</span><span class="kw2">Configuration</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="id">db_file</span><span class="text"> () </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Command_line</span><span class="text">.</span><span class="id">run_main</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> ()</span></code></pre>
<p>this provides Ketrew&#39;s command-line interface, but without any user-defined
commands/workflows (see <code>&lt;script.ml&gt; --help</code>).</p>
<blockquote><p><em>Tip</em>: The build system can launch the OCaml toplevel (<code>utop</code>, or <code>ocaml</code>)
with the library loaded, <strong>and</strong> <code>Ketrew.Command_line.run_main</code>
can be fed a <code>~argv</code> argument. For example:</p>
<pre class='ocaml'><code class='ocaml'><span class="kw">let</span><span class="text"> `</span><span class="kw2">Never_returns</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">db_file</span><span class="text"> = </span><span class="string">&quot;/tmp/ketrew_database_readme&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = </span><span class="kw2">Ketrew_state</span><span class="text">.</span><span class="kw2">Configuration</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="id">db_file</span><span class="text"> () </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Command_line</span><span class="text">.</span><span class="id">run_main</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text">  </span><span class="kw4">~argv</span><span class="text">:[|</span><span class="string">&quot;&quot;</span><span class="text">; </span><span class="string">&quot;--help&quot;</span><span class="text">|] ()</span></code></pre>
<p>will display the default help message.</p>
</blockquote>
<p>Then, one can add create functions that create and <code>run</code> workflows:</p>
<pre class='ocaml'><code class='ocaml'><span class="kw">let</span><span class="text"> </span><span class="id">run_command_with_lsf</span><span class="text"> </span><span class="id">cmd</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = 
    </span><span class="id">parse_host</span><span class="text"> </span><span class="string">&quot;ssh://user42@MyLSFCluster/home/user42/kplayground?shell=bash&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">queue</span><span class="text"> = </span><span class="string">&quot;normalpeople&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">run</span><span class="text"> (
    </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;run_command_with_lsf&quot;</span><span class="text">
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">lsf</span><span class="text"> </span><span class="kw4">~queue</span><span class="text"> </span><span class="kw4">~wall_limit</span><span class="text">:</span><span class="string">&quot;1:30&quot;</span><span class="text"> </span><span class="kw4">~processors</span><span class="text">:(`</span><span class="kw2">Min_max</span><span class="text"> (</span><span class="numeric">1</span><span class="text">,</span><span class="numeric">1</span><span class="text">))
               </span><span class="kw4">~host</span><span class="text"> [</span><span class="id">cmd</span><span class="text">])
  )</span></code></pre>
<p>those can be added to the command-line by providing a <code>Cmdliner.Term.t</code>
(see <a href='http://erratique.ch/software/cmdliner'>documentation</a>)
to <code>run_main</code>.</p>
<pre class='ocaml'><code class='ocaml'><span class="kw">let</span><span class="text"> </span><span class="id">additional_term</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Cmdliner</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">all_args</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">doc</span><span class="text"> = </span><span class="string">&quot; TODO: write some doc here &quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Arg</span><span class="text">.(</span><span class="id">value</span><span class="text"> &amp; </span><span class="id">pos_all</span><span class="text"> </span><span class="kw3">string</span><span class="text"> [] &amp; </span><span class="id">info</span><span class="text"> [] </span><span class="kw4">~docv</span><span class="text">:</span><span class="string">&quot;SPECIFICATION&quot;</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">)
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">treat_list_of_strings</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | </span><span class="string">&quot;lsf&quot;</span><span class="text"> :: </span><span class="id">cmd</span><span class="text"> :: [] -&gt; </span><span class="id">run_command_with_lsf</span><span class="text"> </span><span class="id">cmd</span><span class="text">
    | </span><span class="id">some_other_list</span><span class="text"> -&gt; 
      </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">ketrew_fail</span><span class="text"> </span><span class="string">&quot;Don't know what to do with %s&quot;</span><span class="text"> 
        (</span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="string">&quot;, &quot;</span><span class="text"> </span><span class="id">some_other_list</span><span class="text">)
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Term</span><span class="text">.(</span><span class="id">pure</span><span class="text"> </span><span class="id">treat_list_of_strings</span><span class="text"> $ </span><span class="id">all_args</span><span class="text">)

</span><span class="kw">let</span><span class="text"> `</span><span class="kw2">Never_returns</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">db_file</span><span class="text"> = </span><span class="string">&quot;/path/to/ketrew_database&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = </span><span class="kw2">Ketrew_state</span><span class="text">.</span><span class="kw2">Configuration</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="id">db_file</span><span class="text"> () </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Command_line</span><span class="text">.</span><span class="id">run_main</span><span class="text"> </span><span class="kw4">~additional_term</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> ()</span></code></pre>
<p>then one should be able to add and activate mini-workflow with:</p>
<pre><code>&lt;script.ml&gt; call lsf &quot;&lt;some shell command to run on the cluster&gt;&quot;</code></pre>
<p>To display the current status:</p>
<pre><code>&lt;script.ml&gt; info</code></pre>
<p>To run as many steps as possible until a “fix-point” is reached:</p>
<pre><code>&lt;script.ml&gt; run fix</code></pre>
<p>To kill running jobs use</p>
<pre><code>&lt;script.ml&gt; kill &lt;target-ID&gt;</code></pre>
<p>or do an interactive murder:</p>
<pre><code>&lt;script.ml&gt; kill --interactive</code></pre>
<p>See the file <code>src/test/cli.ml</code> for more examples (<em>work-in-progress</em>).</p>
<h2 id="Tests">Tests</h2>
<p>Run the tests like this:</p>
<pre class='bash'><code class='bash'>    ketrew_test_ssh=&lt;Host&gt; _obuild/ketrew-test/ketrew-test.asm [-no-color]</code></pre>
<p>where <code>&lt;Host&gt;</code> is often an entry in your <code>.ssh/config</code> file.</p>
<p>The test will indeed look for the environment variable <code>ketrew_test_ssh</code>; if
not defined it will use <code>&quot;localhost&quot;</code>. But for the test to succeed it should be
an SSH host for which the user running the test does not need password.
The test will run some commands on that host and create files and directories
in its <code>/tmp</code> directory.</p>
<h2 id="Authors">Authors</h2>
<ul>
 <li><a href='http://seb.mondet.org'>Sebastien Mondet</a> (<code>seb@mondet.org</code>)</li>
</ul>

<h2 id="CodeDocumentation">Code Documentation</h2>
<ul>
 <li><a href='api/index.html'>ocaml-doc for the API</a></li>
</ul>

<p><object class="img-rounded"  type="image/svg+xml" data="modules.svg"
style="transform-origin: 0% 100% 0;
       transform: translateY(-100%) rotate(90deg);"
  >Your browser does not support SVG</object></p>
</div></body><html>
