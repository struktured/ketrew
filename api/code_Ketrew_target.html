<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of class methods" rel=Appendix href="index_methods.html">
<link title="Index of class types" rel=Appendix href="index_class_types.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Ketrew" rel="Chapter" href="Ketrew.html">
<link title="Ketrew_artifact" rel="Chapter" href="Ketrew_artifact.html">
<link title="Ketrew_command_line" rel="Chapter" href="Ketrew_command_line.html">
<link title="Ketrew_database" rel="Chapter" href="Ketrew_database.html">
<link title="Ketrew_edsl" rel="Chapter" href="Ketrew_edsl.html">
<link title="Ketrew_error" rel="Chapter" href="Ketrew_error.html">
<link title="Ketrew_host" rel="Chapter" href="Ketrew_host.html">
<link title="Ketrew_long_running" rel="Chapter" href="Ketrew_long_running.html">
<link title="Ketrew_lsf" rel="Chapter" href="Ketrew_lsf.html">
<link title="Ketrew_monitored_script" rel="Chapter" href="Ketrew_monitored_script.html">
<link title="Ketrew_nohup_setsid" rel="Chapter" href="Ketrew_nohup_setsid.html">
<link title="Ketrew_path" rel="Chapter" href="Ketrew_path.html">
<link title="Ketrew_pervasives" rel="Chapter" href="Ketrew_pervasives.html">
<link title="Ketrew_state" rel="Chapter" href="Ketrew_state.html">
<link title="Ketrew_target" rel="Chapter" href="Ketrew_target.html">
<link title="Ketrew_unix_process" rel="Chapter" href="Ketrew_unix_process.html">
<link title="Ketrew_user_command" rel="Chapter" href="Ketrew_user_command.html"><title>Ketrew API : Ketrew_target</title>
</head>
<body>
<code class="code"><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Ketrew_pervasives</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Path</span>&nbsp;=&nbsp;<span class="constructor">Ketrew_path</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Host</span>&nbsp;=&nbsp;<span class="constructor">Ketrew_host</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Artifact</span>&nbsp;=&nbsp;<span class="constructor">Ketrew_artifact</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Command</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Ketrew_gen_target_v0_t</span>.command&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;host:&nbsp;<span class="constructor">Host</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;action:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Shell</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;];<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;shell&nbsp;?(host=<span class="constructor">Host</span>.tmp_on_localhost)&nbsp;s&nbsp;=&nbsp;{&nbsp;host;&nbsp;action&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Shell</span>&nbsp;s}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_host&nbsp;t&nbsp;=&nbsp;t.host<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_string_hum&nbsp;{host;&nbsp;action&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Shell</span>&nbsp;cmd}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fmt&nbsp;<span class="string">"Shell[%S]&nbsp;on&nbsp;%s"</span>&nbsp;cmd&nbsp;(<span class="constructor">Host</span>.to_string_hum&nbsp;host)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_output&nbsp;{host;&nbsp;action}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;action&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Shell</span>&nbsp;cmd&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Host</span>.get_shell_command_output&nbsp;host&nbsp;cmd<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;get_output&nbsp;t&nbsp;<span class="comment">(*&nbsp;TODO&nbsp;optimize&nbsp;to&nbsp;not&nbsp;record&nbsp;the&nbsp;output&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;(_,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">include</span>&nbsp;<span class="constructor">Ketrew_gen_target_v0_t</span><br>
<br>
<span class="keyword">let</span>&nbsp;nop&nbsp;:&nbsp;build_process&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Artifact</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Value</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Unit</span>)<br>
<br>
<span class="keyword">let</span>&nbsp;create<br>
&nbsp;&nbsp;&nbsp;&nbsp;?id&nbsp;?name&nbsp;?(persistance=<span class="keywordsign">`</span><span class="constructor">Input_data</span>)&nbsp;?(metadata=<span class="constructor">Artifact</span>.unit)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(dependencies=[])&nbsp;?(make=nop)<br>
&nbsp;&nbsp;&nbsp;&nbsp;result_type&nbsp;=&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;history&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Created</span>&nbsp;<span class="constructor">Time</span>.(now&nbsp;())&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;id&nbsp;=&nbsp;<span class="constructor">Option</span>.value&nbsp;id&nbsp;~default:(<span class="constructor">Unique_id</span>.create&nbsp;())&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;{&nbsp;id;&nbsp;name&nbsp;=&nbsp;<span class="constructor">Option</span>.value&nbsp;name&nbsp;~default:id;&nbsp;persistance;&nbsp;metadata;<br>
&nbsp;&nbsp;&nbsp;&nbsp;dependencies;&nbsp;make;&nbsp;result_type;&nbsp;history&nbsp;}<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Create a new  target but activated from a created one; 
    raises <code class="code"><span class="constructor">Invalid_argument</span> _</code> if current status is not <code class="code"><span class="keywordsign">`</span><span class="constructor">Created</span> _</code>. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;activate_exn&nbsp;t&nbsp;~by&nbsp;=&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.history&nbsp;<span class="keyword">with</span>&nbsp;<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Created</span>&nbsp;_&nbsp;<span class="keyword">as</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;t&nbsp;<span class="keyword">with</span>&nbsp;history&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Activated</span>&nbsp;(<span class="constructor">Time</span>.now&nbsp;(),&nbsp;c,&nbsp;by)&nbsp;}<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;(<span class="constructor">Invalid_argument</span>&nbsp;<span class="string">"activate_exn"</span>)<br>
<br>
<span class="keyword">let</span>&nbsp;make_succeed_exn&nbsp;t&nbsp;artifact&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.history&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Activated</span>&nbsp;_&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Running</span>&nbsp;_&nbsp;<span class="keyword">as</span>&nbsp;state&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;t&nbsp;<span class="keyword">with</span>&nbsp;history&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Successful</span>&nbsp;(<span class="constructor">Time</span>.now&nbsp;(),&nbsp;state,&nbsp;artifact)&nbsp;}<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;(<span class="constructor">Invalid_argument</span>&nbsp;<span class="string">"make_succeed_exn"</span>)<br>
<br>
<span class="keyword">let</span>&nbsp;kill_exn&nbsp;?(msg=<span class="string">""</span>)&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.history&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Activated</span>&nbsp;_&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Running</span>&nbsp;_&nbsp;<span class="keyword">as</span>&nbsp;state&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;t&nbsp;<span class="keyword">with</span>&nbsp;history&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Dead</span>&nbsp;(<span class="constructor">Time</span>.now&nbsp;(),&nbsp;state,&nbsp;<span class="keywordsign">`</span><span class="constructor">Killed</span>&nbsp;msg)&nbsp;}<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;(<span class="constructor">Invalid_argument</span>&nbsp;<span class="string">"kill_exn"</span>)<br>
<br>
<span class="keyword">let</span>&nbsp;make_fail_exn&nbsp;?(msg=<span class="string">""</span>)&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.history&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Activated</span>&nbsp;_&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Running</span>&nbsp;_&nbsp;<span class="keyword">as</span>&nbsp;state&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;t&nbsp;<span class="keyword">with</span>&nbsp;history&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Dead</span>&nbsp;(<span class="constructor">Time</span>.now&nbsp;(),&nbsp;state,&nbsp;<span class="keywordsign">`</span><span class="constructor">Failed</span>&nbsp;msg)&nbsp;}<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;(<span class="constructor">Invalid_argument</span>&nbsp;<span class="string">"kill_exn"</span>)<br>
<br>
<span class="keyword">let</span>&nbsp;set_running_exn&nbsp;t&nbsp;~plugin_name&nbsp;~run_parameters&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.history&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Activated</span>&nbsp;_&nbsp;<span class="keyword">as</span>&nbsp;state&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;t&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;history&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Running</span>&nbsp;({plugin_name;&nbsp;run_parameters;&nbsp;run_history&nbsp;=&nbsp;[]},&nbsp;state)}<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;invalid_argument_exn&nbsp;~where:<span class="string">"Target"</span>&nbsp;(fmt&nbsp;<span class="string">"set_running_exn"</span>)<br>
<br>
<span class="keyword">let</span>&nbsp;update_running_exn&nbsp;t&nbsp;~run_parameters&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.history&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Running</span>&nbsp;(bookkeeping,&nbsp;activation)&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;t&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;history&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Running</span>&nbsp;({bookkeeping&nbsp;<span class="keyword">with</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_parameters;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_history&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bookkeeping.run_parameters&nbsp;::&nbsp;bookkeeping.run_history},<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activation)}<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;invalid_argument_exn&nbsp;~where:<span class="string">"Target"</span>&nbsp;(fmt&nbsp;<span class="string">"update_running_exn"</span>)<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;active&nbsp;?id<br>
&nbsp;&nbsp;&nbsp;&nbsp;?name&nbsp;?persistance&nbsp;?metadata<br>
&nbsp;&nbsp;&nbsp;&nbsp;?dependencies&nbsp;?make<br>
&nbsp;&nbsp;&nbsp;&nbsp;artifact&nbsp;=&nbsp;<br>
&nbsp;&nbsp;activate_exn&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">User</span>&nbsp;(create&nbsp;?id&nbsp;?name&nbsp;?persistance&nbsp;?metadata<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?dependencies&nbsp;?make&nbsp;artifact)<br>
<br>
<span class="keyword">let</span>&nbsp;id&nbsp;t&nbsp;:&nbsp;<span class="constructor">Unique_id</span>.t&nbsp;=&nbsp;t.id<br>
<br>
<span class="keyword">let</span>&nbsp;serialize&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Ketrew_gen_versioned_j</span>.string_of_target&nbsp;(<span class="keywordsign">`</span><span class="constructor">V0</span>&nbsp;t)<br>
<br>
<span class="keyword">let</span>&nbsp;deserialize&nbsp;s&nbsp;:&nbsp;(t,&nbsp;_)&nbsp;<span class="constructor">Result</span>.t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Result</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;return&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Ketrew_gen_versioned_j</span>.target_of_string&nbsp;s&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V0</span>&nbsp;v0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v0<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail&nbsp;(<span class="keywordsign">`</span><span class="constructor">Target</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Deserilization</span>&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)))<br>
<br>
<span class="keyword">let</span>&nbsp;log&nbsp;t&nbsp;=&nbsp;<span class="constructor">Log</span>.(brakets&nbsp;(sf&nbsp;<span class="string">"Target:&nbsp;%s&nbsp;(%s)"</span>&nbsp;t.name&nbsp;t.id))<br>
<br>
<br>
<br>
</code></body></html>