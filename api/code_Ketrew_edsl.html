<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of class methods" rel=Appendix href="index_methods.html">
<link title="Index of class types" rel=Appendix href="index_class_types.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Ketrew" rel="Chapter" href="Ketrew.html">
<link title="Ketrew_artifact" rel="Chapter" href="Ketrew_artifact.html">
<link title="Ketrew_command_line" rel="Chapter" href="Ketrew_command_line.html">
<link title="Ketrew_database" rel="Chapter" href="Ketrew_database.html">
<link title="Ketrew_edsl" rel="Chapter" href="Ketrew_edsl.html">
<link title="Ketrew_host" rel="Chapter" href="Ketrew_host.html">
<link title="Ketrew_long_running" rel="Chapter" href="Ketrew_long_running.html">
<link title="Ketrew_monitored_script" rel="Chapter" href="Ketrew_monitored_script.html">
<link title="Ketrew_nohup_setsid" rel="Chapter" href="Ketrew_nohup_setsid.html">
<link title="Ketrew_path" rel="Chapter" href="Ketrew_path.html">
<link title="Ketrew_pervasives" rel="Chapter" href="Ketrew_pervasives.html">
<link title="Ketrew_state" rel="Chapter" href="Ketrew_state.html">
<link title="Ketrew_target" rel="Chapter" href="Ketrew_target.html">
<link title="Ketrew_unix_process" rel="Chapter" href="Ketrew_unix_process.html"><title>Ketrew API : Ketrew_edsl</title>
</head>
<body>
<code class="code"><span class="keyword">open</span>&nbsp;<span class="constructor">Ketrew_pervasives</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Host</span>&nbsp;=&nbsp;<span class="constructor">Ketrew_host</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Path</span>&nbsp;=&nbsp;<span class="constructor">Ketrew_path</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Target</span>&nbsp;=&nbsp;<span class="constructor">Ketrew_target</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Artifact</span>&nbsp;=&nbsp;<span class="constructor">Ketrew_artifact</span><br>
<br>
&nbsp;<br>
<span class="keyword">type</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Ketrew_host</span>.t<br>
<br>
<span class="keyword">class</span>&nbsp;<span class="keyword">type</span>&nbsp;user_artifact&nbsp;=&nbsp;<span class="keyword">object</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;artifact_type&nbsp;:&nbsp;<span class="constructor">Artifact</span>.<span class="constructor">Type</span>.t<br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;path&nbsp;:&nbsp;string<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** Return the path of the artifact if the artifact is a volume containing
      a single file or directory. *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;unit&nbsp;=&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;artifact_type&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Value</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Unit</span><br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;path&nbsp;=&nbsp;failwith&nbsp;<span class="string">"Unit&nbsp;has&nbsp;no&nbsp;path"</span><br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;file&nbsp;?(host=&nbsp;<span class="constructor">Host</span>.localhost)&nbsp;path&nbsp;&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;basename&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;artifact_type:&nbsp;<span class="constructor">Artifact</span>.<span class="constructor">Type</span>.t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Volume</span>&nbsp;<span class="constructor">Artifact</span>.<span class="constructor">Volume</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~root:(<span class="constructor">Path</span>.absolute_directory_exn&nbsp;(<span class="constructor">Filename</span>.dirname&nbsp;path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(file&nbsp;basename))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;path&nbsp;=&nbsp;path<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Artifact.Volume.all_paths&nbsp;v&nbsp;|&gt;&nbsp;List.hd_exn&nbsp;|&gt;&nbsp;Path.to_string&nbsp;in&nbsp;*)</span><br>
<br>
<span class="keyword">class</span>&nbsp;<span class="keyword">type</span>&nbsp;user_target&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;activate&nbsp;:&nbsp;unit<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;name&nbsp;:&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_active:&nbsp;bool<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;id:&nbsp;<span class="constructor">Unique_id</span>.t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;render:&nbsp;<span class="constructor">Ketrew_target</span>.t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;dependencies:&nbsp;user_target&nbsp;list<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">let</span>&nbsp;user_target_internal<br>
&nbsp;&nbsp;?(active&nbsp;=&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;?(dependencies&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;?(name:&nbsp;string&nbsp;option)<br>
&nbsp;&nbsp;?(make:&nbsp;<span class="constructor">Target</span>.build_process&nbsp;=&nbsp;<span class="constructor">Target</span>.nop)<br>
&nbsp;&nbsp;?(returns&nbsp;=&nbsp;unit)<br>
&nbsp;&nbsp;()<br>
&nbsp;&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;id&nbsp;=&nbsp;<span class="constructor">Unique_id</span>.create&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">object</span>&nbsp;(self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;active&nbsp;=&nbsp;active<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;name&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;name&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;id&nbsp;=&nbsp;id<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;dependencies&nbsp;=&nbsp;dependencies<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;activate&nbsp;=&nbsp;active&nbsp;&lt;-&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_active&nbsp;=&nbsp;active<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;render&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;creation&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;active&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Target</span>.active&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">Target</span>.create&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;creation&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~id:self<span class="keywordsign">#</span>id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~dependencies:(<span class="constructor">List</span>.map&nbsp;dependencies&nbsp;~f:(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<span class="keywordsign">#</span>id))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:self<span class="keywordsign">#</span>name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make&nbsp;returns<span class="keywordsign">#</span>artifact_type<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;target&nbsp;?active&nbsp;?dependencies&nbsp;?make&nbsp;?returns&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;user_target_internal&nbsp;?active&nbsp;?dependencies&nbsp;~name&nbsp;?make&nbsp;?returns&nbsp;()<br>
<span class="keyword">let</span>&nbsp;active&nbsp;&nbsp;?dependencies&nbsp;?make&nbsp;?returns&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;user_target_internal&nbsp;~active:<span class="keyword">true</span>&nbsp;?dependencies&nbsp;~name&nbsp;?make&nbsp;?returns&nbsp;()<br>
<br>
<span class="keyword">type</span>&nbsp;workflow&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;<span class="keyword">mutable</span>&nbsp;targets:&nbsp;user_target&nbsp;list;<br>
}<br>
<br>
<span class="keyword">let</span>&nbsp;workflow&nbsp;targets&nbsp;=&nbsp;{&nbsp;targets&nbsp;}<br>
<span class="keyword">let</span>&nbsp;add_target&nbsp;w&nbsp;t&nbsp;=&nbsp;w.targets&nbsp;&lt;-&nbsp;t&nbsp;::&nbsp;w.targets<br>
<span class="keyword">let</span>&nbsp;make&nbsp;w&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;found_one_active&nbsp;=&nbsp;ref&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;targets&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;w.targets&nbsp;(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!found_one_active&nbsp;=&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;t<span class="keywordsign">#</span>is_active&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;found_one_active&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;t<span class="keywordsign">#</span>render;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;t<span class="keywordsign">#</span>dependencies&nbsp;~f:(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<span class="keywordsign">#</span>render)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">else</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t<span class="keywordsign">#</span>render&nbsp;::&nbsp;<span class="constructor">List</span>.map&nbsp;t<span class="keywordsign">#</span>dependencies&nbsp;~f:(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<span class="keywordsign">#</span>render))<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.concat<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.dedup&nbsp;~compare:<span class="constructor">Target</span>.(<span class="keyword">fun</span>&nbsp;ta&nbsp;tb&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;compare&nbsp;ta.id&nbsp;tb.id)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!found_one_active&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Make</span>&nbsp;(a,&nbsp;targets)]<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"There&nbsp;no&nbsp;active&nbsp;target"</span><br>
<br>
<span class="keyword">let</span>&nbsp;make_workflow&nbsp;t&nbsp;=&nbsp;workflow&nbsp;t&nbsp;|&gt;&nbsp;make<br>
<br>
<span class="keyword">let</span>&nbsp;parse_host:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Host</span>.t&nbsp;=&nbsp;<span class="constructor">Host</span>.of_string<br>
<br>
<span class="keyword">let</span>&nbsp;host_cmdliner_term&nbsp;?(doc=<span class="string">"URI&nbsp;of&nbsp;the&nbsp;host"</span>)&nbsp;how&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Cmdliner</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Term</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;pure&nbsp;(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;parse_host&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;$&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Required</span>&nbsp;p&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Arg</span>.(required&nbsp;<span class="keywordsign">&amp;</span>&nbsp;pos&nbsp;p&nbsp;(some&nbsp;string)&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">&amp;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info&nbsp;[]&nbsp;~doc:<span class="string">"The&nbsp;Host."</span>&nbsp;~docv:<span class="string">"URI"</span>)<br>
&nbsp;&nbsp;)<br>
<br>
<span class="keyword">let</span>&nbsp;nohup_setsid&nbsp;~host&nbsp;cmds&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Ketrew_nohup_setsid</span>.create&nbsp;~host&nbsp;cmds<br>
<br>
<span class="keyword">let</span>&nbsp;direct_shell_command&nbsp;?host&nbsp;cmd&nbsp;=<br>
&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Direct_command</span>&nbsp;<span class="constructor">Target</span>.<span class="constructor">Command</span>.(shell&nbsp;?host&nbsp;cmd)<br>
</code></body></html>