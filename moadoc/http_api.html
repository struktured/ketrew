<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap-theme.min.css" type="text/css">
  <link rel="stylesheet" href="code_style.css" type="text/css">
  <meta charset="utf-8">
  <title>Ketrew: http_api</title>
</head>
  <body><div class="container">
  <h1>Ketrew: http_api</h1>
  <h2>Contents</h2>
<ul>
 <li><a href='#Examples'>Examples</a>
 </li>
</ul>
<h2 id="Examples">Examples</h2>
<p>Let&#39;s create a test environment, and source the resulting shell environment:</p>
<pre><code>./please.sh test-env
. _obuild/test.env</code></pre>
<p>Let&#39;s add some targets to the database (c.f. <code>src/test/cli.ml</code>):</p>
<pre><code>kttest website</code></pre>
<p>Now we can start the server:</p>
<pre><code>ktapp start-server</code></pre>
<p>The sever can be killed anytime with:</p>
<pre><code>ktkillserver</code></pre>
<p>We use <code>curl</code>, here on the <code>/targets</code> service:</p>
<pre><code>curl -k &quot;$ktest_url/targets&quot;</code></pre>
<p>The option <code>return-error-messages</code> is set to true, so the server is nice and
says what went wrong:</p>
<pre class='badresult'><code class='badresult'>Error: Wrong HTTP Request: Authentication → Insufficient credentials</code></pre>
<p>In <code>_obuild/test-authorized-tokens</code> there is an “easy token” <code>&quot;nekot&quot;</code>:</p>
<pre><code>curl -k &quot;$ktest_url/targets?token=nekot&quot;</code></pre>
<pre class='badresult'><code class='badresult'>Error: Wrong HTTP Request: format-parameter → Missing parameter</code></pre>
<p>Let&#39;s try again:</p>
<pre><code>curl -k &quot;$ktest_url/targets?token=nekot&amp;format=json&quot;</code></pre>
<p>Yay we get some Json \o/ i.e. a list of target-identifiers.</p>
<pre class='goodresult'><code class='goodresult'>[
  &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_994326685&quot;,
  &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_930807020&quot;,
  &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_781944104&quot;,
  &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_641907500&quot;,
  &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_366831641&quot;,
  &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_332180439&quot;,
  &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_290180182&quot;
]</code></pre>
<p>We can use <code>id</code> parameters to expand the Json serialization of one or more
targets:</p>
<pre><code>one_of_them=&quot;ketrew_2014-08-21-21h49m48s823ms-UTC_781944104&quot;
curl -k &quot;$ktest_url/targets?token=nekot&amp;format=json&amp;id=$one_of_them&quot;</code></pre>
<p>or with a pretty-printer:</p>
<pre><code>curl -k &quot;$ktest_url/targets?token=nekot&amp;format=json&amp;id=$one_of_them&quot; | json_pp</code></pre>
<pre class='goodresult'><code class='goodresult'>[
   [
      &quot;V0&quot;,
      {
         &quot;history&quot; : [
            &quot;Created&quot;,
            1408654128.82403
         ],
         &quot;make&quot; : [
            &quot;Direct_command&quot;,
            {
               &quot;action&quot; : [
                  &quot;Shell_command&quot;,
                  &quot;git add api &amp;&amp; git ci -a -m &#39;update website&#39; &quot;
               ],
               &quot;host&quot; : {
                  &quot;playground&quot; : [
                     &quot;Some&quot;,
                     {
                        &quot;kind&quot; : &quot;Directory&quot;,
                        &quot;path&quot; : &quot;/tmp&quot;
                     }
                  ],
                  &quot;connection&quot; : &quot;Localhost&quot;,
                  &quot;execution_timeout&quot; : &quot;None&quot;,
                  &quot;default_shell&quot; : {
                     &quot;command_option&quot; : &quot;-c&quot;,
                     &quot;options&quot; : [],
                     &quot;binary&quot; : &quot;None&quot;,
                     &quot;command_name&quot; : &quot;sh&quot;
                  },
                  &quot;name&quot; : &quot;file://tmp&quot;
               }
            }
         ],
         &quot;dependencies&quot; : [
            &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_332180439&quot;
         ],
         &quot;persistance&quot; : &quot;Input_data&quot;,
         &quot;name&quot; : &quot;Commit&quot;,
         &quot;if_fails_activate&quot; : [
            &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_641907500&quot;
         ],
         &quot;id&quot; : &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_781944104&quot;,
         &quot;metadata&quot; : &quot;Unit&quot;,
         &quot;equivalence&quot; : &quot;Same_active_condition&quot;,
         &quot;condition&quot; : &quot;None&quot;
      }
   ]
]</code></pre>
<p>By the way, the <code>/targets</code> service is
<a href='http://en.wiktionary.org/wiki/nullipotent'>nullipotent</a>, and <code>GET</code>-only:</p>
<pre><code>curl -k --data &quot;something to post&quot; &quot;$ktest_url/targets?token=nekot&amp;format=json&quot;</code></pre>
<pre class='badresult'><code class='badresult'>Error: Wrong HTTP Request: wrong method → POST</code></pre>
<!--
" Vim stuff:

let $ktest_url="https://localhost:8443"
nmap <leader>I 0mki:read !<esc><leader>x`k07x
nmap <leader>E Ilet $<esc>V<leader>xu

-->
</div></body><html>
