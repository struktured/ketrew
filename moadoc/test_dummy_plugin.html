<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap-theme.min.css" type="text/css">
  <link rel="stylesheet" href="code_style.css" type="text/css">
  <meta charset="utf-8">
  <title>Ketrew: test dummy plugin</title>
</head>
  <body><div class="container">
  <h1>Ketrew: test dummy plugin</h1>
  <h2>Contents</h2>
<pre class='ocaml'><code class='ocaml'><span class="text">
</span></code></pre>
<p>This plugin “inherits” from the implementation of <code>Ketrew_daemonize</code> and adds a
new “query” (that just retrives the result of the <code>date</code> command; pretty
useless).</p>
<pre class='ocaml'><code class='ocaml'><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew_pervasives</span><span class="text">

</span></code></pre>
<p>The name has to be “unique”; the <code>create</code> function calls
<code>Ketrew_daemonize.create</code> and changes the <code>name</code>:</p>
<pre class='ocaml'><code class='ocaml'><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="string">&quot;dummy&quot;</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">program</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> `</span><span class="kw2">Long_running</span><span class="text">  (</span><span class="numeric">_</span><span class="text">, </span><span class="id">serialized</span><span class="text">) =
    </span><span class="kw2">Ketrew_daemonize</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">program</span><span class="text"> </span><span class="kw">in</span><span class="text">
  `</span><span class="kw2">Long_running</span><span class="text"> (</span><span class="id">name</span><span class="text">, </span><span class="id">serialized</span><span class="text">)

</span></code></pre>
<h2 id="Implementation">Implementation</h2>
<p>The module <code>Another_long_running</code> is the actual implementation of the plugin.</p>
<p>The functions <code>additional_queries</code> and <code>query</code> deal with the <code>&quot;date&quot;</code> query,
or pass the baby to the <code>Ketrew_daemonize</code> module.</p>
<pre class='ocaml'><code class='ocaml'><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Another_long_running</span><span class="text"> : </span><span class="kw2">Ketrew_long_running</span><span class="text">.</span><span class="kw2">LONG_RUNNING</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Ketrew_daemonize</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">name</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">additional_queries</span><span class="text"> </span><span class="id">run_param</span><span class="text"> =
    (</span><span class="string">&quot;date&quot;</span><span class="text">, </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Display the date, not even on the right host&quot;</span><span class="text">))
    :: </span><span class="id">additional_queries</span><span class="text"> </span><span class="id">run_param</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">query</span><span class="text"> </span><span class="id">run_param</span><span class="text"> </span><span class="id">item</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">item</span><span class="text"> = </span><span class="string">&quot;date&quot;</span><span class="text"> </span><span class="kw1">then</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">Ketrew_host</span><span class="text">.(</span><span class="id">get_shell_command_output</span><span class="text"> (</span><span class="id">of_string</span><span class="text"> </span><span class="string">&quot;/tmp&quot;</span><span class="text">)
                           (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;date&quot;</span><span class="text">))
        &gt;&gt;&lt; </span><span class="kw">function</span><span class="text">
        | `</span><span class="kw2">Ok</span><span class="text"> (</span><span class="id">o</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">o</span><span class="text">
        | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
          </span><span class="id">fail</span><span class="text"> </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Command `date` failed: &quot;</span><span class="text"> % </span><span class="id">s</span><span class="text"> (</span><span class="kw2">Ketrew_error</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">))
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">else</span><span class="text"> </span><span class="comment">(* call Ketrew_daemonize's function: *)</span><span class="text">
      </span><span class="id">query</span><span class="text"> </span><span class="id">run_param</span><span class="text"> </span><span class="id">item</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span></code></pre>
<h2 id="Registration">Registration</h2>
<p>Registering the plugin is a simple function call using first class modules:</p>
<pre class='ocaml'><code class='ocaml'><span class="kw">let</span><span class="text"> () =
  </span><span class="kw2">Ketrew_state</span><span class="text">.</span><span class="id">register_long_running_plugin</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> (</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Another_long_running</span><span class="text">)


</span></code></pre>
</div></body><html>
